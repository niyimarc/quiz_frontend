{% extends "base.html" %}
{% load static %}
{% block meta %}
<meta property="og:title" content="{{business_name}} Delete Quiz">
<meta property="og:description" content="Welcome to {{business_name}}">
<meta property="og:url" content="{{ request.build_absolute_uri }}">
<meta property="og:image" content="{% static 'assets/img/logo/black-logo.svg' %}">
{% endblock meta %}
{% block title %}
{{business_name}} - Delete Quiz
{% endblock title %}

{% block content %}
{% include "includes/manage_quiz.html" %}
{% endblock content %}

{% block extra_js %}
<script>
    window.QUIZ_DATA = window.QUIZ_DATA || null;
</script>


<script>
document.addEventListener("DOMContentLoaded", function () {
  let currentQuizId = null;

  function openQuizEditModal(quizId, status, name) {
    currentQuizId = quizId;
    document.getElementById("quizIdInput").value = quizId;

    // Set dropdown to match current status
    document.getElementById("status").value = status;

    // Set current name in input
    document.getElementById("quiz_name").value = name;
  }
  window.openQuizEditModal = openQuizEditModal; // ✅ global function

  // Handle Update Status form
  document.getElementById("statusForm").addEventListener("submit", function(e) {
    e.preventDefault();
    const quizId = document.getElementById("quizIdInput").value;
    const status = document.getElementById("status").value;

    fetch(`/proxy/?endpoint=/api/quiz/update_quiz_status/&endpoint_type=private`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ quiz_id: quizId, new_status: status })
    })
    .then(res => res.json())
    .then(result => {
      if (result.error) {
        alert("Error: " + result.error);
      } else {
        alert(result.message || "Quiz status updated!");
        location.reload();
      }
    })
    .catch(err => {
      console.error("Error updating status:", err);
      alert("Something went wrong. Please try again.");
    });
  });

  // Handle Edit Name form
  document.getElementById("nameForm").addEventListener("submit", function(e) {
    e.preventDefault();
    const quizId = document.getElementById("quizIdInput").value;
    const newName = document.getElementById("quiz_name").value;

    fetch(`/proxy/?endpoint=/api/quiz/edit_quiz_name/&endpoint_type=private`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ quiz_id: quizId, new_name: newName })
    })
    .then(res => res.json())
    .then(result => {
      if (result.error) {
        alert("Error: " + result.error);
      } else {
        alert(result.message || "Quiz name updated!");
        location.reload();
      }
    })
    .catch(err => {
      console.error("Error updating name:", err);
      alert("Something went wrong. Please try again.");
    });
  });

  // Toggle between forms
  document.getElementById("statusTab").addEventListener("click", function() {
    document.getElementById("statusForm").style.display = "block";
    document.getElementById("nameForm").style.display = "none";
    this.classList.add("active");
    document.getElementById("nameTab").classList.remove("active");
  });

  document.getElementById("nameTab").addEventListener("click", function() {
    document.getElementById("statusForm").style.display = "none";
    document.getElementById("nameForm").style.display = "block";
    this.classList.add("active");
    document.getElementById("statusTab").classList.remove("active");
  });
});


document.addEventListener("DOMContentLoaded", () => {
    let quizToDelete = null;

    // When user clicks "Delete" button, set quiz details in modal
    document.querySelectorAll(".delete-quiz-btn").forEach(button => {
        button.addEventListener("click", () => {
            quizToDelete = {
                id: button.dataset.quizId,
                name: button.dataset.quizName,
                element: button.closest(".quiz-card") // card container for removal
            };

            document.getElementById("deleteQuizMessage").textContent =
                `Are you sure you want to delete "${quizToDelete.name}"?`;

            document.getElementById("deleteQuizId").value = quizToDelete.id;
        });
    });

    // Confirm delete
    document.getElementById("confirmDeleteQuizBtn").addEventListener("click", () => {
        if (!quizToDelete) return;

        fetch(`/proxy/?endpoint=/api/quiz/delete_quiz/&endpoint_type=private`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ quiz_id: quizToDelete.id })
        })
        .then(res => res.json())
        .then(result => {
            if (result.success) {
                // Hide modal
                const modal = bootstrap.Modal.getInstance(document.getElementById("deleteQuizModal"));
                modal.hide();

                // Remove quiz card from DOM
                if (quizToDelete.element) {
                    quizToDelete.element.remove();
                }

                alert("Quiz deleted successfully!");
            } else {
                alert(result.error || "Failed to delete quiz.");
            }
        })
        .catch(err => {
            console.error("Error deleting quiz:", err);
            alert("An error occurred while deleting the quiz.");
        });
    });
});

document.addEventListener("DOMContentLoaded", () => {
    let currentQuizId = null;

    // Open modal and set quiz ID
    document.querySelectorAll(".grant-access-btn").forEach(button => {
        button.addEventListener("click", () => {
            currentQuizId = button.dataset.quizId;
            document.getElementById("grantQuizId").value = currentQuizId;
        });
    });

    // Handle form submission
    document.getElementById("grantAccessForm").addEventListener("submit", function(e) {
        e.preventDefault();

        const quizId = document.getElementById("grantQuizId").value;
        const targetUsername = document.getElementById("targetUsername").value;
        const accessType = document.getElementById("accessType").value;

        fetch(`/proxy/?endpoint=/api/quiz/grant_quiz_access/&endpoint_type=private`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                quiz_id: quizId,
                target_username: targetUsername,
                access_type: accessType
            })
        })
        .then(res => res.json())
        .then(result => {
            if (result.error) {
                alert(result.error);
            } else {
                alert(result.message || "Access granted successfully!");
                const modal = bootstrap.Modal.getInstance(document.getElementById("grantAccessModal"));
                modal.hide();
                document.getElementById("grantAccessForm").reset();
            }
        })
        .catch(err => {
            console.error("Error granting access:", err);
            alert("Something went wrong. Please try again.");
        });
    });
});


document.querySelectorAll(".grant-access-btn").forEach(button => {
    button.addEventListener("click", () => {
        const currentQuizId = button.dataset.quizId;
        document.getElementById("grantQuizId").value = currentQuizId;

        const dropdown = document.getElementById("existingAccesses");
        dropdown.innerHTML = `<option disabled selected>Loading...</option>`;

        // ✅ Pass quiz_id separately from endpoint
        const url = `/proxy/?endpoint=/api/quiz/get_quiz_access_list/&endpoint_type=private&quiz_id=${encodeURIComponent(currentQuizId)}`;

        fetch(url, {
            method: "GET",
            credentials: "include"
        })
        .then((response) => response.json())
        .then((data) => {
            dropdown.innerHTML = "";

            if (data.error) {
                dropdown.innerHTML = `<option disabled>${data.error}</option>`;
                return;
            }

            if (data.length === 0) {
                dropdown.innerHTML = `<option disabled>No users have access yet</option>`;
            } else {
                data.forEach((access) => {
                    const option = document.createElement("option");
                    option.value = access.participant_username;
                    option.textContent = `${access.participant_username} (${access.access_type})`;
                    dropdown.appendChild(option);
                });
            }
        })
        .catch((err) => {
            console.error("Error loading access list:", err);
            dropdown.innerHTML = `<option disabled>Error loading users</option>`;
        });
    });
});

</script>
{% endblock extra_js %}